<!doctype html>
<html>

<head>
    <title>Sounds</title>
</head>

<body>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const red = document.getElementById("red");
            red.addEventListener("click", key);
            const blue = document.getElementById("blue");
            blue.addEventListener("click", key);
            const green = document.getElementById("green");
            green.addEventListener("click", key);
            const yellow = document.getElementById("yellow");
            yellow.addEventListener("click", key);
            const playButton = document.getElementById("play");
            playButton.addEventListener("click", play);
            const ne = document.getElementById("new");
            ne.addEventListener("click", restart);
        });

        let song = [1, 2, 3, 4];
        let played = [];
        let checkTimeout;

        function key(e) {
            const id = e.target.id;
            const mapping = {
                "red": 1,
                "blue": 2,
                "green": 3,
                "yellow": 4,
            };
            const pitch = mapping[id];
            played.push(pitch);
            playNote(pitch);
            console.log(played);
            clearTimeout(checkTimeout);
            checkTimeout = setTimeout(verify, 3000);
        }
        function verify() {
            console.log(played);
            console.log(song);
            if(JSON.stringify(played) === JSON.stringify(song)) {
                console.log("win");
                alert("You should become a musician!");
            } else {
                console.log("loose");
                alert("No that's not it. Keep on practicing!");
            }
            played = [];
        }
        function restart(e) {
            function randomTone() {
                return Math.floor(Math.random() * 4) + 1;
            }
            song = [];
            for (let i = 0; i < 5; i++) {
                song.push(randomTone());
            }
        }
        function play(e) {
            function delayedNote(index) {
                setTimeout(function () {
                    const note = song[index];
                    playNote(note);
                }, 500 * index);
            }
            for (let i = 0; i < song.length; i++) {
                delayedNote(i);
            }
        }
        async function playNote(pitch) {
            const note = "note.mp3";
            const context = new AudioContext();
            const source = context.createBufferSource();
            const audioBuffer = await fetch(note)
                .then(res => res.arrayBuffer())
                .then(ArrayBuffer => context.decodeAudioData(ArrayBuffer));
            source.buffer = audioBuffer;
            source.playbackRate.value = pitch
            source.connect(context.destination);
            source.start();
        }
    </script>
    <style>
        #red{
            background-color: #f44336;
        }
        #blue {
            background-color: #008CBA;
        }
        #green {
            background-color: #4CAF50;
        }
        #yellow {
            background-color: #FFC300;
        }
        .pianokey {
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
        }
        .button {
            border: none;
            background-color: #D3D3D3;
            color: black;
            padding: 5px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
        }
    </style>
    <h1>Play the song again!</h1>
    <p>Listen to the generated song and play the songs again</p>
    <button id="red" class="pianokey">Red</button>
    <button id="blue" class="pianokey">Blue</button>
    <button id="green" class="pianokey">Green</button>
    <button id="yellow" class="pianokey">Yellow</button>
    <br />
    <button id="play" class="button">Play again</button>
    <button id="new" class="button">New Game</button>
</body>
</html>
